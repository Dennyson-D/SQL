SET LANGUAGE BRAZILIAN
; WITH TABA AS(
SELECT *,
  CONVERT(DECIMAL(8,2),(SALARIO/CH_HS_MENSAIS)) AS SALARIO_HORA
 ,CASE  WHEN FUNCAO IN ('PROFESSOR','COORDENADOR') THEN CONVERT(DECIMAL(8,2),(SALARIO/6)) ELSE 0 END AS DSR

FROM (	SELECT PFUNC.CODFILIAL
, PFUNC.CHAPA
, PFUNC.NOME
, PPESSOA.CPF
, PCODSITUACAO.DESCRICAO AS SITUACAO
, (PSECAO.CODIGO+' - '+PSECAO.DESCRICAO) AS SECAO 
, CASE  WHEN  PFUNCAO.NOME LIKE 'PROF%' THEN 'PROFESSOR' ELSE CASE WHEN PFUNCAO.NOME LIKE 'COO%' THEN 'COORDENADOR' ELSE PFUNCAO.NOME END END AS FUNCAO 
, CONVERT(DECIMAL(8,2),PFUNC.PERCENTADIANT) AS PERCENTADIANT
, CONVERT(DECIMAL(8,3),(PFUNCVAL.VALOR/100)) AS QUINQUENIO_PERC
, PFUNC.SALARIO
,
	 (SELECT SUM(PFFINANC.VALOR) 
			  FROM PFFINANC
			 WHERE PFUNC.CHAPA = PFFINANC.CHAPA
			   AND PFFINANC.ANOCOMP = 2020--:ANO
			   AND PFFINANC.MESCOMP = 4  --:MES
			   AND PFFINANC.CODEVENTO IN ('0003','0004','0582')) DESCONTO,

	PFUNC.USASALCOMPOSTO,
	CASE WHEN (PFUNCAO.NOME LIKE 'PROF%' OR PFUNCAO.NOME LIKE 'COO%') THEN CONVERT(DECIMAL(8,2),(CONVERT(DECIMAL(8,2),JORNADAMENSAL)/60)) END AS CH_HS_MENSAIS,
	PFUNC.JORNADAMENSAL

	FROM PFUNC  (NOLOCK) 
	JOIN PPESSOA (NOLOCK) ON PFUNC.CODPESSOA = PPESSOA.CODIGO
	LEFT JOIN PFUNCVAL (NOLOCK) ON PFUNC.CHAPA = PFUNCVAL.CHAPA
	LEFT JOIN PFUNCAO (NOLOCK) ON PFUNCAO.CODIGO = PFUNC.CODFUNCAO
	LEFT JOIN PSECAO (NOLOCK) ON PSECAO.CODIGO = PFUNC.CODSECAO
	LEFT JOIN PCODSITUACAO (NOLOCK) ON PCODSITUACAO.CODCLIENTE = PFUNC.CODSITUACAO

	WHERE 
	PFUNC.CODTIPO <> 'T'  AND
	PFUNC.CODSITUACAO <> 'D' AND
	PFUNC.CODFILIAL IN ('1','5','15','18','19','16')

	) AS AA
),
  
 TABB AS (
   SELECT *
   ,CASE USASALCOMPOSTO WHEN 0 THEN 0 WHEN 1 THEN CONVERT(DECIMAL(8,2),ROUND((SALARIO+(ISNULL(DSR,0)))*0.12,2)) END AS HATIV
   
     FROM TABA
 ),

 TABC AS (
   SELECT *
   ,QUINQUENIO_VAL = CONVERT(SMALLMONEY,((SALARIO + ISNULL(DSR,0) + ISNULL(HATIV,0))* QUINQUENIO_PERC))
   ,(SELECT TOP 1 CONVERT(SMALLMONEY,PF.VALOR) FROM PFFINANC AS PF WHERE PF.CODEVENTO = 0167 AND PF.CHAPA = TABB.CHAPA AND  ANOCOMP = 2019 /*:ANO*/ AND MESCOMP = 8 /*--:MES*/ ) AS DSR_EVEN
   ,(SELECT TOP 1 CONVERT(SMALLMONEY,PF.VALOR) FROM PFFINANC AS PF WHERE PF.CODEVENTO = 0168 AND PF.CHAPA = TABB.CHAPA AND  ANOCOMP = 2019 /*:ANO*/ AND MESCOMP = 8 /*--:MES*/ ) AS HATIV_EVEN
   ,(SELECT TOP 1 CONVERT(SMALLMONEY,PF.VALOR) FROM PFFINANC AS PF WHERE PF.CODEVENTO = 0240 AND PF.CHAPA = TABB.CHAPA AND  ANOCOMP = 2019 /*:ANO*/ AND MESCOMP = 8 /*--:MES*/ ) AS QUINQ_EVEN
   /*,(SELECT TOP 1 ISNULL(SUM(PF.VALOR),0) FROM PFFINANC AS PF 
		    JOIN PEVENTO (NOLOCK) AS P ON P.CODIGO = PF.CODEVENTO 
            WHERE  PF.CHAPA = TABB.CHAPA AND  ANOCOMP = 2019 /*:ANO*/ AND MESCOMP = 8 /*--:MES*/ AND P.TOTALIZADOR = 2 ) AS SOMA_TOTAL2*/

			,(SELECT TOP 1 ISNULL(SUM(PF.VALOR),0) FROM PFFINANC AS PF 
		    JOIN PEVENTO (NOLOCK) AS P ON P.CODIGO = PF.CODEVENTO 
            WHERE  PF.CHAPA = TABB.CHAPA AND  ANOCOMP = 2019 /*:ANO*/ AND MESCOMP = 8 /*--:MES*/ AND PROVDESCBASE = 'P' AND TOTALIZADOR = 2 ) AS TOTAL_SEM_HA

			,(SELECT TOP 1 PF.REF FROM PFFINANC AS PF 
		    JOIN PEVENTO (NOLOCK) AS P ON P.CODIGO = PF.CODEVENTO 
            WHERE  PF.CHAPA = TABB.CHAPA AND  ANOCOMP = 2019 /*:ANO*/ AND MESCOMP = 8 /*--:MES*/ AND PROVDESCBASE = 'P' AND TOTALIZADOR = 2 ) AS REF_SEM_HA


    FROM TABB 
 ),

 TABD AS (
 SELECT DISTINCT TABC.*
 , CONVERT(SMALLMONEY,(SALARIO +ISNULL(DSR_EVEN,0) + ISNULL(HATIV_EVEN,0)+ ISNULL(QUINQ_EVEN,0))) AS SALARIO_TOTAL
 , CONVERT(SMALLMONEY,(SALARIO+ISNULL(DSR,0) + ISNULL(HATIV,0)+ ISNULL(QUINQUENIO_VAL,ISNULL(QUINQ_EVEN,0)))) AS SALARIO_TOTAL_COM
 
  
  FROM TABC    
 ),

  TABE AS (
   
   SELECT *
   ,CONVERT(SMALLMONEY,(TOTAL_SEM_HA + ISNULL(DSR_SEM_HA,0) + ISNULL(QUINQ_SEM_HA,0)) / REF_SEM_HA) AS VR_HR_FIN_SEM_HA

          FROM 
           ( 
			SELECT *
			      ,CONVERT(DECIMAL(8,2),(TOTAL_SEM_HA/6)) AS DSR_SEM_HA
				  ,CONVERT(DECIMAL(8,2),(TOTAL_SEM_HA + (TOTAL_SEM_HA/6)) * QUINQUENIO_PERC) AS QUINQ_SEM_HA
		  
			FROM TABD 
			) AS AA

  )

SELECT CODFILIAL
, CHAPA
, NOME
, SITUACAO
, SECAO
, FUNCAO AS TIPO
, REPLACE(CONVERT(DECIMAL(8,2),PERCENTADIANT/100),'.',',') AS PER_ADTO
, REPLACE(QUINQUENIO_PERC,'.',',') AS QUINQUENIO_PERC
, CONVERT(SMALLMONEY,SALARIO) AS SALARIO
, CONVERT(SMALLMONEY,DSR_EVEN) AS DSR_EVEN
, CONVERT(SMALLMONEY,HATIV_EVEN) AS HATIV_EVEN
, CONVERT(SMALLMONEY,QUINQ_EVEN) AS QUINQ_EVEN
, SALARIO_TOTAL
, CONVERT(SMALLMONEY,CH_HS_MENSAIS) AS CH_HS_MENSAIS
/*, REPLACE(CONVERT(DECIMAL(8,2),(SALARIO_TOTAL/CH_HS_MENSAIS)),'.',',') AS VR_H_FINAL*/
      , REPLACE(CONVERT(DECIMAL(8,2),(SALARIO_TOTAL_COM/CH_HS_MENSAIS)),'.',',') AS VR_H_FINAL_COM
	  , VR_HR_FIN_SEM_HA
	  

 FROM TABE
 
  WHERE CHAPA IN (050134)
--(  180117,180222,180005,180509,180696,180021,180338,180404,180421,180290,180172,180333,180555,180142,180128,180479,180558,180684,180685,180122,180143,180022,180693,180541,180611,180084,180698,180115
--,180714,180069,180683,180585,180640,180372,180613,180480,180675,180205,180507,180691,180420,180697,180255,180692,180249,180043,180445,180288,180512,180488,180584,180695,180224,180694,180024,180543
--,180649,180676,180540,180023,180542,180650,180617,180016,180546,180565,180009,180009,180446,180715,180513,180248,180717,180679,180516,180554,019001,059002
--)

ORDER BY NOME,CHAPA